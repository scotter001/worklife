<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vn.worklife.user.quanlydiemden.service.DiemDenGTDuongBoService">
    <resultMap id="DiemDenVO" type="DiemDenVO">
        <result property="idDiemDen" column="iddiemden"/>
        <result property="lyTrinh" column="lytrinh"/>
        <result property="tenDiem" column="tendiem"/>
        <result property="moTaViTri" column="motavitri"/>
        <result property="diemDau_X" column="diemdau_x"/>
        <result property="diemDau_Y" column="diemdau_y"/>
        <result property="diemCuoi_X" column="diemcuoi_x"/>
        <result property="diemCuoi_Y" column="diemcuoi_y"/>
        <result property="nam" column="nam"/>
        <result property="vu_TN" column="vu_tn"/>
        <result property="vu_Chet" column="vu_chet"/>
        <result property="vu_BiThuong" column="vu_bithuong"/>
        <result property="dienGiai" column="diengiai"/>
        <result property="ngayXoa" column="ngayxoa"/>
        <result property="trenSong" column="trensong"/>
        <result property="phamVi_ChieuDai" column="phamvi_chieudai"/>
        <result property="lyDo_TiemAnNguyHiem" column="lydo_tiemannguyhiem"/>
        <result property="tenSong" column="tensong"/>
        <result property="rongSong" column="rongsong"/>
        <result property="chieuRong" column="chieurong"/>
        <result property="chieuSau" column="chieusau"/>
        <result property="bh_GioiHan" column="bh_gioihan"/>
        <result property="bh_NguyHiem" column="bh_nguyhiem"/>
        <result property="bh_ChiDan" column="bh_chidan"/>
        <result property="tinhKhong" column="tinhkhong"/>
        <result property="tinhTrang_TruChongVa" column="tinhtrang_truchongva"/>
        <result property="ketCau_TruChongVa" column="ketcau_truchongva"/>
        <result property="donViBaoTri" column="donvibaotri"/>
        <result property="tinhHinh_TNGT" column="tinhhinh_tngt"/>
        <result property="gtThuy" column="gtthuy"/>
        <result property="tieuChi_DiemDenGTThuy" column="tieuchi_diemdengtthuy"/>
        <result property="nhieuHuyen" column="nhieuhuyen"/>
        <result property="tenDuong" column="tenduong"/>
        <result property="tenHatQL" column="tenhatql"/>
        <result property="listIdHuyen" column="listidhuyen"/>
        <result property="recordTotals" column="totalrecords"/>
    </resultMap>
    <select id="selectListDiemDenDB" resultMap="DiemDenVO">
        WITH TempResult AS (
        select DISTINCT
            dd1.iddiemden,
            dd1.idtuyenduong,
            tuyenduong.tenduong as tenduong,
            isnull(lytrinh,'') as lytrinh,
            isnull(tendiem,'') as tendiem,
            isnull(motavitri,'') as motavitri,
            isnull(diemdau_x,'') as diemdau_x,
            isnull(diemdau_y,'') as diemdau_y,
            isnull(diemcuoi_x,'') as diemcuoi_x,
            isnull(diemcuoi_y,'') as diemcuoi_y,
            isnull(nam,'') as nam,
            isnull(vu_tn,'') as vu_tn,
            isnull(vu_chet,'') as vu_chet,
            isnull(vu_bithuong,'') as vu_bithuong,
            loai,
            isnull(diengiai,'') as diengiai,
            isnull(convert(nvarchar,ngayxoa,103),'') as ngayxoa,
            (SELECT
            STUFF(
            (SELECT distinct ', ' + dmhuyen.tenhuyen
            FROM
            diemden dd2
            LEFT JOIN diemden_huyen ON diemden_huyen.iddiemden = dd2.iddiemden
            LEFT JOIN dmhuyen ON dmhuyen.idhuyen = diemden_huyen.idhuyen
            WHERE dd2.iddiemden = dd1.iddiemden AND diemden_huyen.idhuyen IN (select idhuyen from diemden_huyen GROUP BY idhuyen)
            FOR XML PATH(''),TYPE).value('/','NVARCHAR(MAX)'), 1, 1, ''))
            AS nhieuhuyen,
            (SELECT
            STUFF(
            (SELECT distinct ',' + convert(nvarchar,dmhuyen.idhuyen)
            FROM
            diemden dd3
            LEFT JOIN diemden_huyen ON diemden_huyen.iddiemden = dd3.iddiemden
            LEFT JOIN dmhuyen ON dmhuyen.idhuyen = diemden_huyen.idhuyen
            WHERE dd3.iddiemden = dd1.iddiemden AND diemden_huyen.idhuyen IN (select idhuyen from diemden_huyen GROUP BY idhuyen)
            FOR XML PATH(''),TYPE).value('/','NVARCHAR(MAX)'), 1, 1, ''))
            AS listidhuyen
        from diemden dd1
        LEFT JOIN tuyenduong ON tuyenduong.idtuyenduong = dd1.idtuyenduong
        LEFT JOIN diemden_huyen ON dd1.iddiemden = diemden_huyen.iddiemden
        <where>
            dd1.gtthuy is null and dd1.ngayxoa is null
            <if test="optional.loaiDiem != -1">
                and dd1.loai = #{optional.loaiDiem}
            </if>
            <if test="optional.idHuyen != -1">
                AND diemden_huyen.idhuyen = #{optional.idHuyen}
            </if>
            <if test="optional.tenDuong != null and optional.tenDuong != ''">
                AND dbo.removecharvn(lower(tuyenduong.tenduong)) LIKE dbo.removecharvn(lower(N'%${optional.tenDuong}%'))
            </if>
        </where>
        ),
        TempCount AS (
        SELECT COUNT(*) AS
        totalrecords
        FROM TempResult
        ) SELECT *
        FROM
        TempResult, TempCount
        ORDER BY iddiemden DESC
        OFFSET ${start} ROWS
        FETCH NEXT
        ${length} ROWS ONLY;
    </select>
    <insert id="insertDiemDenDuongBo" useGeneratedKeys="true" keyProperty="idDiemDen" keyColumn="iddiemden">
        insert into diemden
            (
             idtuyenduong,
             lytrinh,
             tendiem,
             motavitri,
             diemdau_x,
             diemdau_y,
             diemcuoi_x,
             diemcuoi_y,
             nam,
             vu_tn,
             vu_chet,
             vu_bithuong,
             loai,
             diengiai,
             ngayxoa
             )
             VALUES
                 (
                  #{idTuyenDuong},
                  nullif(#{lyTrinh},''),
                  nullif(#{tenDiem},''),
                  nullif(#{moTaViTri},''),
                  nullif(convert(float,#{diemDau_X}),''),
                  nullif(convert(float,#{diemDau_Y}),''),
                  nullif(convert(float,#{diemCuoi_X}),''),
                  nullif(convert(float,#{diemCuoi_Y}),''),
                  nullif(#{nam},''),
                  nullif(convert(int,#{vu_TN}),''),
                  nullif(convert(int,#{vu_Chet}),''),
                  nullif(convert(int,#{vu_BiThuong}),''),
                  #{loai},
                  nullif(#{dienGiai},''),
                  nullif(convert(date,#{ngayXoa},103),'')
                  )
    </insert>
    <update id="updateDiemDenDuongBo">
        update diemden
            set
            idtuyenduong = #{idTuyenDuong},
            lytrinh = nullif(#{lyTrinh},''),
            tendiem = nullif(#{tenDiem},''),
            motavitri = nullif(#{moTaViTri},''),
            diemdau_x = nullif(convert(float,#{diemDau_X}),''),
            diemdau_y = nullif(convert(float,#{diemDau_Y}),''),
            diemcuoi_x = nullif(convert(float,#{diemCuoi_X}),''),
            diemcuoi_y = nullif(convert(float,#{diemCuoi_Y}),''),
            nam = nullif(#{nam},''),
            vu_tn = nullif(convert(int,#{vu_TN}),''),
            vu_chet = nullif(convert(int,#{vu_Chet}),''),
            vu_bithuong = nullif(convert(int,#{vu_BiThuong}),''),
            loai = #{loai},
            diengiai = nullif(#{dienGiai},''),
            ngayxoa = nullif(convert(date,#{ngayXoa},103),'')
        Where iddiemden = #{idDiemDen}
    </update>
    <select id="getPosition" resultType="java.lang.Integer">
        WITH TempResult AS
                 (
                     select iddiemden
                     from diemden
                    LEFT JOIN tuyenduong ON tuyenduong.idtuyenduong = diemden.idtuyenduong
                 ),
             MyCte AS (
                 SELECT *, RowNum = row_number() OVER ( order by iddiemden DESC)
                 from TempResult
             )
        SELECT RowNum
        FROM MyCte
        WHERE iddiemden = #{idDiemDen}
    </select>
    <delete id="deleteDiemDenById">
        delete diemden_huyen where iddiemden = #{idDiemDen}
    </delete>
    <insert id="insertDiemDenHuyen">
        insert into diemden_huyen (iddiemden, idhuyen) VALUES (#{idDiemDen}, #{idHuyen})
    </insert>
</mapper>