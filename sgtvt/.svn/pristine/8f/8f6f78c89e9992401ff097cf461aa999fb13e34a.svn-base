<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vn.worklife.user.quanlytuyenduong.service.DmQLBaoCaoTTCauDuongService">
    <resultMap id="QLBaoCaoTTCDVO" type="QLBaoCaoTTCDVO">
        <result property="idLyTrinh" column="idlytrinh"/>
        <result property="group_id" column="group_id"/>
        <result property="idgroup" column="idgroup"/>
        <result property="iddh" column="iddh"/>
        <result property="nam" column="nam"/>
        <result property="quy" column="quy"/>
        <result property="idcau" column="idcau"/>
        <result property="tinhTrang" column="tinhtrang"/>
        <result property="group_name" column="group_name"/>
        <result property="ngayBC" column="ngaybc"/>
    </resultMap>

    <select id="selectListBaoCaoTTCau" resultMap="QLBaoCaoTTCDVO">
        WITH C1 AS(
                SELECT
                    [group].group_name, [group].group_id,   cau.idcau, tinhtrang_cau.ngaybc, tinhtrang_cau.id FROM cau

                    RIGHT JOIN [group] ON   (cau.idgroup = [group].group_id)

                    LEFT JOIN tinhtrang_cau ON

                                                (cau.idcau = tinhtrang_cau.idcau AND

                                                 tinhtrang_cau.nam =  #{optional.nam} AND
                                                 tinhtrang_cau.quy = #{optional.quy})
                WHERE [group].is_department = 3
        )
        SELECT * FROM
            (
                SELECT DISTINCT group_name,group_id,CONVERT ( NVARCHAR, NULLIF( ngaybc, '' ), 103 )  as ngaybc FROm C1 WHERE id IS NULL
                UNION
                SELECT group_name,group_id,CONVERT ( NVARCHAR, NULLIF( ngaybc, '' ), 103 )  as ngaybc FROm C1
                WHERE id IN(    SELECT MAX(id) FROm C1 WHERE id IS NOT NULL GROUP BY group_id)
                      AND group_id NOT IN (SELECT group_id FROM  (SELECT DISTINCT group_name,group_id,ngaybc  FROm C1 WHERE id IS NULL) S0 )
            ) S1
        ORDER BY group_name	ASC
    </select>
    <select id="selectListBaoCaoTTDuong" resultMap="QLBaoCaoTTCDVO">
        WITH C1 AS(
                SELECT
                    [group].group_name,
                    [group].group_id,
                    lytrinh.idlytrinh,
                    tinhtrang_duong.ngaybc,
                    tinhtrang_duong.id
                FROM
                    duong_hat
                    INNER JOIN
                    lytrinh
                        ON
                            duong_hat.iddh = lytrinh.iddh
                    RIGHT JOIN
                    [group]
                        ON
                            (duong_hat.idgroup = [group].group_id)
                    LEFT JOIN
                    tinhtrang_duong
                        ON
                            (lytrinh.idlytrinh = tinhtrang_duong.idlytrinh AND
                             tinhtrang_duong.nam = #{optional.nam} AND
                             tinhtrang_duong.quy = #{optional.quy})
                WHERE [group].is_department = 3
        )
        SELECT * FROM
            (
                SELECT DISTINCT group_name,group_id,CONVERT(NVARCHAR,nullif(ngaybc,''), 103) as ngaybc FROm C1 WHERE id IS NULL
                UNION
                SELECT group_name,group_id,CONVERT ( NVARCHAR, NULLIF( ngaybc, '' ), 103 )  as ngaybc FROm C1
                WHERE id IN(    SELECT MAX(id) FROm C1 WHERE id IS NOT NULL GROUP BY group_id)
                      AND group_id NOT IN (SELECT group_id FROM  (SELECT DISTINCT group_name,group_id,ngaybc  FROm C1 WHERE id IS NULL) S0 )
            ) S1
        ORDER BY group_name	ASC
    </select>
</mapper>
