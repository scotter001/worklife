<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="vn.worklife.manager.security.service.WorklifeRoleService">
    <resultMap id="WorklifeRole" type="WorklifeRoleVO">
        <result property="roleId" column="role_id"/>
        <result property="groupId" column="group_id"/>
        <result property="roleName" column="role_name"/>
        <result property="roleCode" column="role_code"/>
        <result property="roleDescription" column="role_description"/>
        <result property="createAt" column="create_at"/>
        <result property="updateAt" column="update_at"/>
        <association property="group" javaType="WorklifeGroupVO" select="vn.worklife.manager.group.service.WorklifeGroupService.selectGroupByGroupId" column="{groupId=group_id}"/>
    </resultMap>
    
    <resultMap id="WorklifeRoleWithStatus" type="WorklifeRoleVO">
        <result property="roleId" column="role_id"/>
        <result property="groupId" column="group_id"/>
        <result property="roleName" column="role_name"/>
        <result property="roleCode" column="role_code"/>
        <result property="roleDescription" column="role_description"/>
        <result property="createAt" column="create_at"/>
        <result property="updateAt" column="update_at"/>
        <result property="roleStatus" column="role_status"/>        
    </resultMap>
    
    <resultMap id="WorklifeSingleRole" type="WorklifeRoleVO">
        <result property="roleId" column="role_id"/>
        <result property="groupId" column="group_id"/>
        <result property="roleName" column="role_name"/>
        <result property="roleCode" column="role_code"/>
        <result property="roleDescription" column="role_description"/>
        <result property="createAt" column="create_at"/>
        <result property="updateAt" column="update_at"/>
       	<association property="group" javaType="WorklifeGroupVO" select="vn.worklife.manager.group.service.WorklifeGroupService.selectGroupByGroupId" column="{groupId=group_id}"></association>
       	<collection property="listPermission" javaType="ArrayList" select="vn.worklife.manager.security.service.WorklifePermissionService.selectListPermissionByRoleId" column="{roleId=role_id}"></collection>
    </resultMap>
    <resultMap id="WorklifeRoleCheck" type="WorklifeRoleVO">
        <result property="roleId" column="role_id"/>
    </resultMap>

    <insert id="insertRole" useGeneratedKeys="true"  keyProperty="role_id">
        <!-- <selectKey keyProperty="roleId" resultType="int" order="AFTER">
            SELECT currval('role_role_id_seq');
        </selectKey> -->
        <selectKey keyProperty="roleId" resultType="int" order="AFTER">
        	SELECT MAX(role_id)
        	FROM role
        </selectKey>
        INSERT INTO role( 	
        	group_id,
	       	role_name,
	       	role_code,
	       	role_description,
	       	create_at,
	       	update_at
		) VALUES(		
			#{groupId},
			#{roleName},
			#{roleCode},
			#{roleDescription},
	       	GETDATE(),
	       	GETDATE()
		)
    </insert>
    
    <!-- Nhat fix check role_code -->
    <select id="checkRoleExsit" resultMap="WorklifeRoleCheck">
    	SELECT TOP 1 *
    	FROM(
    		SELECT 
    			role_id
  			FROM 
  				role
			WHERE role_code = #{roleCode}
    	) AS t
    </select>
    
    <insert id="intertNewPermission4Role" parameterType="WorklifeRoleGroupVO">
    	INSERT INTO 
    		role_group (
    			group_id,
    			permission_id,
    			role_id
   			) 
    	VALUES (
    		#{groupId},
    		#{permissionId},
    		#{roleId}
  		)
    </insert>

    <insert id="insertRoleUser">
        INSERT INTO role_user( 	
        	id_user,
			role_id
		) VALUES(
			#{userId},
        	#{roleId}
		)
    </insert>
    
    <update id="updateRole" parameterType="WorklifeRoleVO">
      	UPDATE 	role
        SET 	role_name 			= #{roleName},
		        role_description 	= #{roleDescription},
		        update_at 			= GETDATE()
        WHERE 	role_id 			= #{roleId}
    </update>
    
    <delete id="deleteSingleRoleByRoleId" parameterType="int">
        DELETE
        FROM 	role
        WHERE 	role_id = #{roleId}
    </delete>
    
    <delete id="deleteRoleGroupByRoleId" parameterType="int">
        DELETE
        FROM 	role_group
        WHERE 	role_id = #{roleId}
    </delete>
    
    <delete id="deleteRoleGroupByGroupId" parameterType="int">
        DELETE
        FROM 	role_group
        WHERE 	group_id = #{groupId}
    </delete>
    
    <delete id="deleteRoleGroupByPermissionId" parameterType="int">
        DELETE
        FROM 	role_group
        WHERE 	permission_id = #{permissionId}
    </delete>
    
    <delete id="deleteRoleGroupByGroupIdAndPermissionId" parameterType="WorklifePermissionGroupVO">
        DELETE
        FROM 	role_group
        WHERE 	group_id = #{groupId}
        AND		permission_id = #{permissionId}
    </delete>
    
    <delete id="deleteRoleUserByUserId" parameterType="int">
        DELETE
        FROM 	role_user
        WHERE 	id_user = #{userId}
    </delete>
    
    <delete id="deleteRoleUserByRoleId" parameterType="int">
        DELETE
        FROM 	role_user
        WHERE 	role_id = #{roleId}
    </delete>
    
    <delete id="deleteRoleUser" parameterType="WorklifeRoleUserVO">
        DELETE
        FROM 	role_user
        WHERE 	role_id = #{roleId}
        AND		id_user = #{userId}
    </delete>
    
    <select id="selectAllRoleByGroupId" parameterType="java.util.Map" resultMap="WorklifeRoleWithStatus">
        SELECT 	role.*,
        		(	SELECT 	CASE WHEN id_user IS NOT NULL 
        					THEN 'Y' 
        					ELSE 'N' END 
        			FROM 	role_user 
        			WHERE 	role_user.role_id = role.role_id 
        			AND 	role_user.id_user = #{userId}
        		) AS role_status
        FROM	role
        WHERE 	group_id = #{groupId}
    </select>
    
    <select id="selectListRoleByGroupId" parameterType="WorklifeRoleVO" resultMap="WorklifeRole">
    	<!-- DECLARE RECURSIVE  -->
        <if test="groupId != null and groupId > 0">
			WITH t_cte AS (
				SELECT 
					group_id
				FROM "group"
				WHERE group_id = #{groupId}
		
				UNION All
				SELECT b.group_id
				FROM t_cte as a, "group" as b
				WHERE a.group_id = b.parent_id
				
			)
        </if>
        SELECT 	role.*
        FROM	role
        INNER JOIN "group" AS g ON g.group_id = role.group_id
        WHERE 	1 = 1
        <if test="groupId != null and groupId > 0">
        	<!-- AND role.group_id = #{groupId} -->
        	AND role.group_id IN (
				SELECT 
				DISTINCT
					a.group_id
				FROM t_cte a
			)
        </if>
        <if test="search != '' and search != null">
            AND (	lower(role.role_name) LIKE lower(CONCAT('%', #{search}, '%'))
            		OR lower(role.role_code) LIKE lower(CONCAT('%', #{search}, '%')) 
            		OR lower(role.role_description) LIKE lower(CONCAT('%', #{search}, '%'))
            		OR lower(g.group_name) LIKE lower(CONCAT('%', #{search}, '%')))
        </if>
        <if test="columnName != '' and columnName != null">
            <if test="typeOrder != '' and typeOrder != null">
                ORDER BY
                <if test="columnName == 'role_name'">
                    role_name
                </if>
                <if test="columnName == 'role_code'">
                    role_code
                </if>
                <if test="typeOrder == 'desc'">
                    DESC
                </if>
                <if test="typeOrder == 'asc'">
                    ASC
                </if>
            </if>
        </if>
        OFFSET #{firstIndex} ROWS FETCH NEXT #{recordCountPerPage} ROWS ONLY
    </select>
    
    <select id="countListRoleByGroupId" parameterType="WorklifeRoleVO" resultType="int">
        <if test="groupId != null and groupId > 0">
        	WITH t_cte
			AS (
				SELECT 
					group_id
				FROM "group"
				WHERE group_id = #{groupId}
		
				UNION All
				SELECT b.group_id
				FROM t_cte as a, "group" as b
				WHERE a.group_id = b.parent_id
				
			)
        </if>
        SELECT COUNT(*)
        FROM
        (
        	SELECT 	role.*
	        FROM	role
	        INNER JOIN "group" AS g ON g.group_id = role.group_id
	        WHERE 	1 = 1
	        <if test="groupId != null and groupId > 0">
	        	<!-- AND role.group_id = #{groupId} -->
	        	AND role.group_id IN
	        	<!-- Get all group id from root (id is groupId) to all child  -->
				(
					SELECT 
					DISTINCT
						a.group_id
					FROM t_cte a
				)
	        </if>
	        <if test="search != '' and search != null">
	            AND (	lower(role.role_name) LIKE lower(CONCAT('%', #{search}, '%'))
	            		OR lower(role.role_code) LIKE lower(CONCAT('%', #{search}, '%')) 
	            		OR lower(role.role_description) LIKE lower(CONCAT('%', #{search}, '%'))
	            		OR lower(g.group_name) LIKE lower(CONCAT('%', #{search}, '%')))
	        </if>
        ) AS t
        
    </select>
    
    <select id="checkRoleUsedOrNotUsed" parameterType="int" resultType="int">
        SELECT 	COUNT(role_user.*)
        FROM	role_user
        WHERE	role_id = #{roleId}
    </select>
    
    <select id="selectRoleByUserId" resultMap="WorklifeSingleRole">
        SELECT 	role.*
        FROM	role
        INNER JOIN role_user ON role_user.role_id = role.role_id
        WHERE 	id_user 	= #{userId}
    </select>
    
    <select id="selectListRoleNameByUserId" resultType="String">
    	SELECT Chars = STUFF((
			SELECT ', ' + role.role_name
			FROM role
			INNER JOIN role_user ON role_user.role_id = role.role_id
	        WHERE 	id_user 	= #{userId}
			FOR XML PATH(''), TYPE
		).value('.', 'NVARCHAR(MAX)'), 1, 2, '')
    </select>
    
    <select id="selectRoleByRoleId" resultMap="WorklifeSingleRole">
        SELECT 	role.*
        FROM	role
        WHERE 	role_id 	= #{roleId}
    </select>
</mapper>