<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="vn.worklife.manager.group.service.WorklifeGroupService">
    <resultMap id="WorklifeGroup" type="WorklifeGroupVO">
        <result property="groupId" column="group_id"/>
        <result property="groupName" column="group_name"/>
        <result property="abbreviation" column="abbreviation"/>
        <result property="groupDescription" column="group_description"/>
        <result property="parentId" column="parent_id"/>
        <result property="parentName" column="parent_name"/>
        <result property="isDepartment" column="is_department"/>
        <result property="maHuyen" column="mahuyen"/>
        <result property="maXa" column="maxa"/>
        <result property="listNameOfParent" column="list_name_of_parent"/>
        <result property="listIdOfParent" column="list_id_of_parent"/>
        <result property="createAt" column="create_at"/>
        <result property="updateAt" column="update_at"/>
    </resultMap>

	<select id="selectAllGroupName" resultMap="WorklifeGroup">
		SELECT group_id
			,group_name
		FROM [group] where is_department = 3
	</select>
    
    <insert id="insertGroup">
        <!-- <selectKey keyProperty="groupId" resultType="int" order="AFTER">
            SELECT currval('group_group_id_seq');
        </selectKey> -->
        <selectKey keyProperty="groupId" resultType="int" order="AFTER">
        	SELECT MAX(group_id) FROM "group"
        </selectKey>
        INSERT INTO "group"( 	group_name,
        						abbreviation,
						        group_description,
						        parent_id,
						        is_department,
						        create_at,
						        update_at,
								mahuyen,
								maxa
        					)
        VALUES				( 	#{groupName},
        						#{abbreviation},
						        #{groupDescription},
						        #{parentId},
						        #{isDepartment},
						        #{createAt},
						        #{updateAt},
								#{maHuyen},
								#{maXa}
						    )
    </insert>

    <update id="updateGroup" parameterType="WorklifeGroupVO">
        UPDATE "group"
        SET 	group_name 			= #{groupName},
        		abbreviation		= #{abbreviation},
        		group_description 	= #{groupDescription},
        		parent_id 			= #{parentId},
        		mahuyen 			= #{maHuyen},
				maxa				= #{maXa},
        		is_department 		= #{isDepartment},
        		update_at 			= #{updateAt}
        WHERE 	group_id 			= #{groupId}
    </update>

    <delete id="deleteSingleGroupByGroupId" parameterType="int">
        DELETE
        FROM "group"
        WHERE group_id = #{groupId}
    </delete>

    <delete id="deleteMultiGroupSameParentId" parameterType="int">
        DELETE
        FROM "group"
        WHERE parent_id = #{parentId}
    </delete>

    <select id="selectGroupByGroupId" resultMap="WorklifeGroup">
        SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        (SELECT group_name FROM "group" WHERE group_id = (SELECT parent_id FROM "group" WHERE group_id = #{groupId})) AS
		        parent_name,
		        mahuyen,
				maxa,
		        is_department,
		        [dbo].[getfullpathofgroup](parent_id) AS list_name_of_parent,
		        [dbo].[getfulllistparentofgroup](parent_id) AS list_id_of_parent,
		        create_at,
		        update_at
        FROM 	"group"
        WHERE 	group_id = #{groupId}
    </select>

    <select id="selectGroupWithFullPathNameByGroupId" parameterType="WorklifeGroupVO" resultMap="WorklifeGroup" statementType="CALLABLE">
        SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        (SELECT group_name FROM "group" WHERE group_id = (SELECT parent_id FROM "group" WHERE group_id = #{groupId})) AS
		        parent_name,
		        mahuyen,
				maxa,
		        is_department,
		        [dbo].[getfullpathofgroup](parent_id) AS list_name_of_parent,
		        [dbo].[getfulllistparentofgroup](parent_id) AS list_id_of_parent,
		        create_at,
		        update_at
        FROM 	"group"
        WHERE 	group_id = #{groupId}
    </select>

    <select id="selectMultiGroupByParentIdForDropdownlist" parameterType="WorklifeGroupVO" resultMap="WorklifeGroup">
        SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        (SELECT group_name FROM "group" WHERE group_id = (SELECT parent_id FROM "group" WHERE group_id = #{groupId})) AS
		        parent_name,
		        mahuyen,
				maxa,
		        is_department,
		        [dbo].[getfullpathofgroup](parent_id) AS list_name_of_parent,
		        [dbo].[getfulllistparentofgroup](parent_id) AS list_id_of_parent,
		        create_at,
		        update_at
        FROM 	"group"
        WHERE 1 = 1
        <if test="idGroupUserLogin != idSuperAdminGroup">
        	AND group_id = #{idGroupUserLogin}
        </if>
        <if test="parentId > -2 and idGroupUserLogin == idSuperAdminGroup">
            AND parent_id = #{parentId}
        </if>
        <if test="groupId > -1 and idGroupUserLogin == idSuperAdminGroup">
            <![CDATA[ AND 	group_id 	<> #{groupId} ]]>
        </if>
    </select>
    
    <select id="selectAllParentGroup" parameterType="WorklifeGroupVO" resultMap="WorklifeGroup">
        SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        mahuyen,
				maxa,
		        is_department,
		        create_at,
		        update_at
        FROM 	"group"
        WHERE parent_id = -1
    </select>

    <select id="selectMultiGroupByParentId" parameterType="WorklifeGroupVO" resultMap="WorklifeGroup">
        <if test="idGroupUserLogin != idSuperAdminGroup">
        	WITH t_cte
			AS (
				SELECT 
					group_id
				FROM "group"
				WHERE group_id = #{idGroupUserLogin}
		
				UNION All
				SELECT b.group_id
				FROM t_cte as a, "group" as b
				WHERE a.group_id = b.parent_id
			)
        </if>
        SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        (SELECT group_name FROM "group" WHERE group_id = (SELECT parent_id FROM "group" WHERE group_id = #{groupId})) AS
		        parent_name,
		        mahuyen,
				maxa,
		        is_department,
		        [dbo].[getfullpathofgroup](parent_id) AS list_name_of_parent,
		        [dbo].[getfulllistparentofgroup](parent_id) AS list_id_of_parent,
		        create_at,
		        update_at
        FROM 	"group"
        WHERE 	1 = 1
        
        <!-- Nếu User ko phải nằm trong Group SuperAdmin  -->
        <if test="idGroupUserLogin != idSuperAdminGroup">
        	AND group_id IN
        	(
				SELECT 
				DISTINCT
					a.group_id
				FROM t_cte a
        	)
        </if>
        <if test="parentId > -2">
            AND parent_id = #{parentId}
        </if>
        <if test="search != '' and search != null">
            AND (lower(group_name) LIKE lower(CONCAT('%', #{search}, '%'))
            OR lower(group_description) LIKE lower(CONCAT('%', #{search}, '%'))
            OR lower(abbreviation) LIKE lower(CONCAT('%', #{search}, '%'))
            OR lower([dbo].[getfullpathofgroup](parent_id)) LIKE lower(CONCAT('%', #{search}, '%')))
        </if>
        <if test="columnName != '' and columnName != null">
            <if test="typeOrder != '' and typeOrder != null">
                ORDER BY
                <if test="columnName == 'group_name'">
                    group_name
                </if>
                <if test="columnName == 'group_description'">
                    group_description
                </if>
                <if test="typeOrder == 'desc'">
                    DESC
                </if>
                <if test="typeOrder == 'asc'">
                    ASC
                </if>
            </if>
        </if>
        OFFSET #{firstIndex} ROWS FETCH NEXT #{recordCountPerPage} ROWS ONLY
    </select>

    <select id="selectMultiGroupWithFullPathNameByParentId" parameterType="WorklifeGroupVO" resultMap="WorklifeGroup" statementType="CALLABLE">
        SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        (SELECT group_name FROM "group" WHERE group_id = (SELECT parent_id FROM "group" WHERE group_id = #{groupId})) AS
		        parent_name,
		        mahuyen,
				maxa,
		        is_department,
		        [dbo].[getfullpathofgroup](parent_id) AS list_name_of_parent,
		        [dbo].[getfulllistparentofgroup](parent_id) AS list_id_of_parent,
		        create_at,
		        update_at
        FROM 	"group"
        WHERE 	1 = 1
        <if test="parentId > -2">
            AND parent_id = #{parentId}
        </if>
        <if test="search != '' and search != null">
            AND (lower(group_name) LIKE lower(CONCAT('%', #{search}, '%'))
            OR lower(group_description) LIKE lower(CONCAT('%', #{search}, '%')))
        </if>
        <if test="columnName != '' and columnName != null">
            <if test="typeOrder != '' and typeOrder != null">
                ORDER BY
                <if test="columnName == 'group_name'">
                    group_name
                </if>
                <if test="columnName == 'group_description'">
                    group_description
                </if>
                <if test="typeOrder == 'desc'">
                    DESC
                </if>
                <if test="typeOrder == 'asc'">
                    ASC
                </if>
            </if>
        </if>
        OFFSET #{firstIndex} ROWS FETCH NEXT #{recordCountPerPage} ROWS ONLY
    </select>

    <select id="countMultiGroupByGroupId" parameterType="WorklifeGroupVO" resultType="int">
	    <if test="idGroupUserLogin != idSuperAdminGroup">
        	WITH t_cte
			AS (
				SELECT 
					group_id
				FROM "group"
				WHERE group_id = #{idGroupUserLogin}
		
				UNION All
				SELECT b.group_id
				FROM t_cte as a, "group" as b
				WHERE a.group_id = b.parent_id
			)
        </if>
        SELECT COUNT(*)
        FROM
        (
        	SELECT 	group_id,
		        group_name,
		        abbreviation,
		        group_description,
		        parent_id,
		        (SELECT group_name FROM "group" WHERE group_id = (SELECT parent_id FROM "group" WHERE group_id = #{groupId})) AS
		        parent_name,
		        mahuyen,
				maxa,
		        is_department,
		        [dbo].[getfullpathofgroup](parent_id) AS list_name_of_parent,
		        [dbo].[getfulllistparentofgroup](parent_id) AS list_id_of_parent,
		        create_at,
		        update_at
	        FROM 	"group"
	        WHERE 	1 = 1
	        
	        <!-- Nếu User ko phải nằm trong Group SuperAdmin  -->
	        <if test="idGroupUserLogin != idSuperAdminGroup">
	        	AND group_id IN
	        	(
					SELECT 
					DISTINCT
						a.group_id
					FROM t_cte a
	        	)
	        </if>
	        
	        <if test="parentId > -2">
	            AND parent_id = #{parentId}
	        </if>
	        <if test="search != '' and search != null">
	            AND (lower(group_name) LIKE lower(CONCAT('%', #{search}, '%'))
	            OR lower(group_description) LIKE lower(CONCAT('%', #{search}, '%'))
	            OR lower(abbreviation) LIKE lower(CONCAT('%', #{search}, '%'))
	            OR lower([dbo].[getfullpathofgroup](parent_id)) LIKE lower(CONCAT('%', #{search}, '%')))
	        </if>
        )AS t
    </select>

    <select id="checkGroupHavingChildren" parameterType="WorklifeGroupVO" resultType="int">
        SELECT 	COUNT(*)
        FROM 	"group"
        WHERE 	parent_id = #{groupId}
    </select>
    
    <select id="countPermissionInGroup" parameterType="int" resultType="int">
        SELECT 	COUNT(*)
        FROM 	permission_group
        WHERE 	group_id = #{groupId}
    </select>

    <select id="getListChildrenId" parameterType="WorklifeGroupVO" resultType="int">
        SELECT 	group_id
        FROM 	"group"
        WHERE 	parent_id = #{parentId}
    </select>

    <select id="checkGroupHasUser" parameterType="int" resultType="int">
        SELECT 	COUNT(*)
        FROM 	"users"
        WHERE 	group_id = #{groupId}
    </select>

	<select id="selectAllParentGroupIdsWithType" resultType="java.lang.Integer">
		SELECT 	group_id
		FROM 	"group"
		<where>
			parent_id IN
			<foreach collection="groupIds" item="id" open="(" close=")" separator=",">
				#{id}
			</foreach>
			AND is_department = #{isDepartment}
		</where>
	</select>
</mapper>