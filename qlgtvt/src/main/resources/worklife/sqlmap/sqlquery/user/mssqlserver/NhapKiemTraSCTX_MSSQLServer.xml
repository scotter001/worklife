<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vn.worklife.user.mockup.service.NhapKiemTraSCTXService">

    <resultMap id="NhapKiemTraSCTXVO" type="NhapKiemTraSCTXVO">
        <result property="idSctx" column="idsctx"/>
        <result property="tenDuong" column="tenduong"/>
        <result property="lyTrinhKmDiemDau" column="lytrinhkm_diemdau"/>
        <result property="lyTrinhMDiemDau" column="lytrinhm_diemdau"/>
        <result property="lyTrinhKmDiemCuoi" column="lytrinhkm_diemcuoi"/>
        <result property="lyTrinhMDiemCuoi" column="lytrinhm_diemcuoi"/>
        <result property="noiDungSuaChua" column="noidungsuachua"/>
        <result property="tuNgayKh" column="tungay_kh"/>
        <result property="denNgayKh" column="denngay_kh"/>
        <result property="tuNgayTh" column="tungay_th"/>
        <result property="denNgayTh" column="denngay_th"/>
        <result property="kinhPhiDuyet" column="kinhphi_duyet"/>
        <result property="khoiLuong" column="khoiluong"/>
        <result property="ngayKiemTra" column="ngaykiemtra"/>
        <result property="thucHien" column="thuchien"/>
        <result property="danhGia" column="danhgia"/>
        <result property="dvt" column="dvt"/>
        <result property="loaiSuCo" column="loaisuco"/>
        <result property="nam" column="nam"/>
        <result property="thuocQuy" column="thuocquy"/>
        <result property="recordTotals" column="totalrecords"/>
    </resultMap>

    <select id="selectNhapKiemTraSCTX" resultMap="vn.worklife.user.mockup.service.DanhMucSCTXService.DanhMucSCTXVO">
        select
        danhmuc_sctx.iddmsctx,
        sctx_thuchien.idsctx,
        suco.idtuyenduong,
        tuyenduong.tenduong,
        isnull(lytrinh,'') as lytrinh,
        isnull(noidungsuachua,'') as noidungsuachua,
        isnull(klduyet_tong,'') as klduyet_tong,
        danhmuc_sctx.iddvt,
        dmdvt.ten as tendvt,
        isnull(noidungsuachua,'') as noidungsuachua,
        isnull(sctx_thuchien.kehoach_th,'') as kehoach_th,
        isnull(sctx_thuchien.thoigian_th,'') as thoigian_th,
        isnull(sctx_thuchien.ghichu_th,'') as ghichu_th,
        isnull(convert(nvarchar, sctx_thuchien.ngaykt, 103),'') as ngaykt,
        sctx_thuchien.thuchien,
        isnull(sctx_thuchien.danhgia,'') as danhgia,
        isnull(sctx_thuchien.nguoikt,'') as nguoikt,
        [group].group_name as tenhatql
        from danhmuc_sctx
        LEFT JOIN sctx_thuchien ON sctx_thuchien.iddmsctx = danhmuc_sctx.iddmsctx
        LEFT JOIN suco ON suco.idsuco = danhmuc_sctx.idsuco
        LEFT JOIN tuyenduong ON tuyenduong.idtuyenduong = suco.idtuyenduong
        LEFT JOIN dmdvt ON dmdvt.iddvt = danhmuc_sctx.iddvt
        LEFT JOIN [group] ON [group].group_id = suco.idgroup
        where
        thuocquy = #{quy} and nam = #{nam} and duyet = 1
        <if test="idGroup != 1">
            and suco.idgroup = #{idGroup}
        </if>
        <if test="tinhTrang == 1">
            AND sctx_thuchien.thuchien = 1
        </if>
        <if test="tinhTrang == 0">
            AND ((sctx_thuchien.thuchien is null) or sctx_thuchien.thuchien = 0)
        </if>
        order by suco.idsuco desc
    </select>
    <insert id="insertNhapKiemTraSCTX">
        insert into sctx_thuchien
            (iddmsctx,
             thuchien,
             danhgia,
             ngaykt,
             nguoikt
             )
             VALUES
                 (
                  #{idDmSctx},
                  convert(INT,#{thucHien}),
                  nullif(#{danhGia},''),
                  nullif(convert(date,#{ngayKT},103),''),
                  nullif(#{nguoiKT},'')
                 )
    </insert>
    <update id="updateNhapKiemTraSCTX">
        update sctx_thuchien
        set
        thuchien = convert(INT,#{thucHien}),
        danhgia = nullif(#{danhGia},''),
        ngaykt = nullif(convert(date,#{ngayKT},103),''),
        nguoikt = nullif(#{nguoiKT},'')
        Where idsctx = #{idSctx}
    </update>
    <select id="selectAllTableNotPaging" resultMap="NhapKiemTraSCTXVO">
        SELECT
        th.idsctx,
        td.tenduong,
        sc.lytrinhkm_diemdau,
        sc.lytrinhm_diemdau,
        sc.lytrinhkm_diemcuoi,
        sc.lytrinhm_diemcuoi,
        dm.noidungsuachua,
        ISNULL(CONVERT (varchar(10),th.tungay_kh,103),'')  as tungay_kh,
        ISNULL(CONVERT (varchar(10),th.denngay_kh,103),'')  as denngay_kh,
        ISNULL(CONVERT (varchar(10),th.tungay_th,103),'')  as tungay_th,
        ISNULL(CONVERT (varchar(10),th.denngay_th,103),'')  as denngay_th,
        ISNULL(CONVERT (varchar(10),th.ngaykiemtra,103),'')  as ngaykiemtra,
        dm.khoiluong,
        dm.kinhphi_duyet,
        th.thuchien,
        th.danhgia,
        dm.dvt,
        sc.loaisuco,
        dm.nam,
        dm.thuocquy,
        sc.idgroup
        FROM suco sc
        LEFT JOIN tuyenduong td ON sc.idtuyenduong = td.idtuyenduong
        LEFT JOIN danhmuc_sctx dm ON  sc.idsuco = dm.idsuco
        LEFT JOIN sctx_thuchien th ON th.iddmsctx = dm.iddmsctx
        WHERE sc.idgroup = #{idGroup}
        AND dm.thuocquy = #{thuocQuy}
        AND dm.nam = #{nam}
        AND(
			(#{tinhTrang} = 0 AND th.tungay_th IS NULL)
			OR (#{tinhTrang} = 1 AND th.tungay_th IS NOT NULL)
			OR (#{tinhTrang} = 2 AND th.ngaykiemtra IS NOT NULL)
			OR (#{tinhTrang} = 3 AND th.ngaykiemtra IS NULL)
		)
    </select>
</mapper>
